# FastStone Image Viewer crash at eip image00400000+0x93ab

Last version at the moment of publication is 7.0

![](https://i.imgur.com/mpo3PYo.png)
![](https://i.imgur.com/zrKZkGZ.png)

## Steps to reproduce

1. Use FastStone Image Viewer 7.0
2. Enable pageheap (without verifier reproducing process can be unstable)
```
C:\Program Files (x86)\Windows Kits\10\Debuggers\x86>gflags /p /enable FSViewer.exe /full
Warning: pageheap.exe is running inside WOW64.
This scenario can be used to test x86 binaries (running inside WOW64)
but not native (IA64) binaries.

path: SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options
    fsviewer.exe: page heap enabled
```
3. Run windbg
4. Open FastStone in windbg
5. Open testcase in FastStone
6. This bug does not lead to the process' crash, but I believe it might be potentially exploitable.

## The bug

Image parsing null pointer dereference

```
(cd4.1484): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=00000006 ebx=0093c654 ecx=000000d5 edx=00000000 esi=0d101220 edi=00962fc4
eip=004093ab esp=16a9eaac ebp=16a9eaf4 iopl=0         nv up ei pl nz na po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010202
image00400000+0x93ab:
004093ab 893a            mov     dword ptr [edx],edi  ds:002b:00000000=????????
0:009> kb
 # ChildEBP RetAddr  Args to Child              
WARNING: Stack unwind information not available. Following frames may be wrong.
00 16a9eaf4 00423eec 00000000 0000003c 16a9fe18 image00400000+0x93ab
01 16a9fe18 00685747 07d26a60 00000001 0068551a image00400000+0x23eec
02 16a9fe60 00684582 16a9fea0 006845a0 16a9fe88 image00400000+0x285747
03 16a9fe88 00684b48 0000000f 07ce1200 00684433 image00400000+0x284582
04 16a9fed0 008acf49 16a9fee4 008ad27f 16a9ff10 image00400000+0x284b48
05 16a9ff10 008ad565 16a9ff24 008ad617 16a9ff3c image00400000+0x4acf49
06 16a9ff3c 0042c05b 16a9ff50 0042c065 16a9ff6c image00400000+0x4ad565
07 16a9ff6c 00404c22 16a9ffcc 0040475c 16a9ff80 image00400000+0x2c05b
08 16a9ff80 74ee8484 07ddbf80 74ee8460 ea33814c image00400000+0x4c22
09 16a9ff94 77c02ec0 07ddbf80 db47557a 00000000 KERNEL32!BaseThreadInitThunk+0x24
0a 16a9ffdc 77c02e90 ffffffff 77c1deb5 00000000 ntdll!__RtlUserThreadStart+0x2f
0b 16a9ffec 00000000 00404bf8 07ddbf80 00000000 ntdll!_RtlUserThreadStart+0x1b
```
