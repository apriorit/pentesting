# FastStone Image Viewer crash at eip image00400000+0x2d7d

Last version at the moment of publication is 7.0

![](https://i.imgur.com/mpo3PYo.png)
![](https://i.imgur.com/zrKZkGZ.png)

## Steps to reproduce

1. Use FastStone Image Viewer 7.0
2. Enable pageheap (without verifier reproducing process can be unstable)
```
C:\Program Files (x86)\Windows Kits\10\Debuggers\x86>gflags /p /enable FSViewer.exe /full
Warning: pageheap.exe is running inside WOW64.
This scenario can be used to test x86 binaries (running inside WOW64)
but not native (IA64) binaries.

path: SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options
    fsviewer.exe: page heap enabled
```
3. Run windbg
4. Open FastStone in windbg
5. Open testcase in FastStone
6. This bug does not lead to the process' crash, but I believe it can be exploitable.

## The bug

Image parsing OOB

```
(d80.158): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=00000080 ebx=00000000 ecx=00000020 edx=0d0bf350 esi=07f7605c edi=0d0bf3cc
eip=00402d7d esp=0019ef9c ebp=0019efb8 iopl=0         nv dn ei pl nz na po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010602
image00400000+0x2d7d:
00402d7d f3a5            rep movs dword ptr es:[edi],dword ptr [esi]
0:000> kb
 # ChildEBP RetAddr  Args to Child              
WARNING: Stack unwind information not available. Following frames may be wrong.
00 0019efb8 004bdeb5 0019f398 0019f3ac 004bdf3a image00400000+0x2d7d
01 0019f398 005ee451 00000000 0019f3e0 000003cb image00400000+0xbdeb5
02 0019f430 005ee608 0019f458 005ee62e 0019f450 image00400000+0x1ee451
03 0019f450 005ef03c 0019f4b0 005ef2dd 0019f4a8 image00400000+0x1ee608
04 0019f4a8 005ee9a3 0019f4d0 005ee9ad 0019f4c8 image00400000+0x1ef03c
05 0019f4c8 008c7ce0 0019f4fc 008c7d11 0019f4f0 image00400000+0x1ee9a3
06 0019f4f0 008ca1a1 0019f600 0019f508 008ca1f7 image00400000+0x4c7ce0
07 0019f600 008fc2bc 00000000 00000001 00000001 image00400000+0x4ca1a1
08 0019f680 0091393f 0019f844 00914234 0019f6b0 image00400000+0x4fc2bc
09 0019f6b0 0045e001 00000004 00000004 0d193e01 image00400000+0x51393f
0a 0019f6c0 0045e058 0045e004 0019f80c 00774538 image00400000+0x5e001
0b 0019f6d8 0045e07b 0d193e00 0019f8d4 00459ddf image00400000+0x5e058
0c 0019f6e4 00459ddf 00000100 0019f8d4 0d193e00 image00400000+0x5e07b
0d 0019f8e4 7637be6b 000706d0 00000100 0000004f image00400000+0x59ddf
0e 0019f910 7637833a 045209fe 000706d0 00000100 user32!_InternalCallWinProc+0x2b
0f 0019f9f8 76357afd 045209fe 00000000 00000100 user32!UserCallWinProcCheckWow+0x3aa
10 0019fa34 727eaadd 045209fe 000706d0 00000100 user32!CallWindowProcW+0x8d
11 0019fabc 727eab7b 00000100 0000004f 00180001 comctl32!CallNextSubclassProc+0x11d
12 0019fb3c 727ea935 00000100 0000004f 00180001 comctl32!CallNextSubclassProc+0x1bb
13 0019fb98 7637be6b 000706d0 00000100 0000004f comctl32!MasterSubclassProc+0xa5
14 0019fbc4 7637833a 727ea890 000706d0 00000100 user32!_InternalCallWinProc+0x2b
15 0019fcac 76357afd 727ea890 00000000 00000100 user32!UserCallWinProcCheckWow+0x3aa
16 0019fce8 004b5709 727ea890 000706d0 00000100 user32!CallWindowProcW+0x8d
17 0019fd18 0042d5aa 00000100 0000004f 00180001 image00400000+0xb5709
18 0019fd30 7637be6b 000706d0 00000100 0000004f image00400000+0x2d5aa
19 0019fd5c 7637833a 045209f1 000706d0 00000100 user32!_InternalCallWinProc+0x2b
1a 0019fe44 76377bee 045209f1 00000000 00000100 user32!UserCallWinProcCheckWow+0x3aa
1b 0019fec0 7636cd30 0019ff34 0047aa50 0019fee8 user32!DispatchMessageWorker+0x20e
1c 0019fec8 0047aa50 0019fee8 0019ff00 0093b1bc user32!DispatchMessageA+0x10
1d 0019ff34 0093bace 0019ff48 0093bad8 0019ff80 image00400000+0x7aa50
1e 0019ff80 74ee8484 0031f000 74ee8460 bfff7faf image00400000+0x53bace
1f 0019ff94 77c02ec0 0031f000 659704f0 00000000 KERNEL32!BaseThreadInitThunk+0x24
20 0019ffdc 77c02e90 ffffffff 77c1deda 00000000 ntdll!__RtlUserThreadStart+0x2f
21 0019ffec 00000000 0093b1bc 0031f000 00000000 ntdll!_RtlUserThreadStart+0x1b

```
