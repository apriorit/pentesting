# XnView Standard v2.48 TIF processing OOB, xnview+0x385474

Last version at the moment of publication is 2.48

![](https://i.imgur.com/IHBmtQS.png)

![](https://i.imgur.com/bJ95x8t.png)


## Steps to reproduce

1. Use XnView Standard v2.48
2. Enable pageheap (without verifier reproducing process can be unstable)
```
C:\Program Files (x86)\Windows Kits\10\Debuggers\x86>gflags /p /enable xnview.exe /full
Warning: pageheap.exe is running inside WOW64.
This scenario can be used to test x86 binaries (running inside WOW64)
but not native (IA64) binaries.

path: SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options
    xnview.exe: page heap enabled
```
3. Run windbg
4. Open XnView in windbg
5. Open testcase in XnView

## The bug

TIF file processing OOB

```
(300.3d4): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=00000000 ebx=ffffac40 ecx=fff80000 edx=fffd6200 esi=0ce5de10 edi=20d8f000
eip=01645474 esp=00d7bb5c ebp=00d7bb78 iopl=0         nv up ei ng nz na pe cy
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010287
xnview+0x385474:
01645474 f3aa            rep stos byte ptr es:[edi]
0:000> kb
 # ChildEBP RetAddr  Args to Child              
WARNING: Stack unwind information not available. Following frames may be wrong.
00 00d7bb78 015ceb2c 20ce0a00 20d38e00 0000ac40 xnview+0x385474
01 00d7bb94 014f4c8c 20ce0a00 20de0e00 000561fc xnview+0x30eb2c
02 00d7bbbc 015e7bf3 20ce0a00 00000000 00000010 xnview+0x234c8c
03 00d7bbfc 015e5f60 1a9daf60 20ce0a00 00561fc0 xnview+0x327bf3
04 00d7bc28 015be00f 1a9daf60 20ce0a00 00561fc0 xnview+0x325f60
05 00d7bf74 015bce09 1a9daf60 20ce0a00 00d7c10c xnview+0x2fe00f
06 00d7c1fc 015bc5e0 1a9daf60 0ce5dca8 00000000 xnview+0x2fce09
07 00d7c210 014f4505 1a9daf60 0ce5dca8 0ce5dca8 xnview+0x2fc5e0
08 00d7c22c 014f4424 1a9daf60 0ce5dca8 00000000 xnview+0x234505
09 00d7c354 014f8735 1a9daf60 0ce5dca8 00000002 xnview+0x234424
0a 00d7c388 014f84cc 00d7c808 00d7c3dc 00d7c410 xnview+0x238735
0b 00d7c3b0 013d334a 00d7c808 00d7c3dc 00d7c410 xnview+0x2384cc
0c 00d7c508 013d3586 0000ffff 00d7c528 80006011 xnview+0x11334a
0d 00d7cac0 013d3bcf 80006011 0020023e 00000001 xnview+0x113586
0e 00d7cc04 76c0be6b 0020023e 0000004e 00000000 xnview+0x113bcf
0f 00d7cc30 76be9e65 013d3a20 0020023e 0000004e USER32!_InternalCallWinProc+0x2b
10 00d7ccc8 76be95e7 0020023e 0000004e 00000000 USER32!UserCallDlgProcCheckWow+0x1e5
11 00d7cd20 76be7695 0730e120 00000000 0000004e USER32!DefDlgProcWorker+0xc7
12 00d7cd40 76c0be6b 0020023e 0000004e 00000000 USER32!DefDlgProcA+0x25
13 00d7cd6c 76c0833a 76be7670 0020023e 0000004e USER32!_InternalCallWinProc+0x2b
14 00d7ce54 76bebeca 912a9d10 00007ff9 0000004e USER32!UserCallWinProcCheckWow+0x3aa
15 00d7cec0 76bebc57 0730e120 00000000 00d7d01c USER32!SendMessageWorker+0x20a
16 00d7cf04 71b55ce0 0020023e 0000004e 00000000 USER32!SendMessageW+0x137
17 00d7cfa8 71b6caca 00d7d01c 0014013a 0020023e COMCTL32!CCSendNotify+0x2b940
18 00d7cfe4 76a9e4cf 0020023e 0014013a fffffda6 COMCTL32!SendNotify+0x3a
19 00d7d13c 76a9f1c8 fffffda6 00000000 11506fa8 COMDLG32!SendOFNotify+0x7b
1a 00d7d15c 76a7ee4b 0b0a0fd8 115429cc 00000003 COMDLG32!CLegacyEvents::OnSelectionChange+0x38
1b 00d7d174 71b3c6fa 0b0a0fd8 115429cc 115429c0 COMDLG32!CFileOpenSave::_NotifySelectionChangeCallback+0x2b
1c 00d7d190 76a6b51c 0b0a2fe8 76a7ee20 115429cc COMCTL32!DPA_EnumCallback+0x3a
1d 00d7d1a0 76a7edb1 00000000 115429c0 00000000 COMDLG32!CFileOpenSave::NotifySelectionChangeWithoutParsing+0x1a
1e 00d7d1e0 76a86548 80006011 0014013a 00000001 COMDLG32!CFileOpenSave::_NotifySelectionChange+0x22
1f 00d7d24c 76c0be6b 0014013a 0000052e 00000000 COMDLG32!CFileOpenSave::s_OpenSaveDlgProc+0x7e8
20 00d7d278 76be9e65 76a85d60 0014013a 0000052e USER32!_InternalCallWinProc+0x2b
21 00d7d310 76be95e7 0014013a 0000052e 00000000 USER32!UserCallDlgProcCheckWow+0x1e5
22 00d7d36c 76be9508 072bb070 00000000 0000052e USER32!DefDlgProcWorker+0xc7
23 00d7d390 76c0be6b 0014013a 0000052e 00000000 USER32!DefDlgProcW+0x48
24 00d7d3bc 76c0833a 76be94c0 0014013a 0000052e USER32!_InternalCallWinProc+0x2b
25 00d7d4a4 76c07bee 912a9d20 00007ff9 0000052e USER32!UserCallWinProcCheckWow+0x3aa
26 00d7d520 76c079d0 2bac38a7 00d7d578 71b7ac8d USER32!DispatchMessageWorker+0x20e
27 00d7d52c 71b7ac8d 00d7d558 00000051 00000000 USER32!DispatchMessageW+0x10
28 00d7d578 71c835bc 000000b6 00000000 00000000 COMCTL32!CheckForDragBeginEx+0xdd
29 00d7d634 71b4cdaf 00000000 00000119 000000b6 COMCTL32!CLVMouseManager::HandleMouse+0x828
2a 00d7d7bc 71b1e8c7 00020244 00000201 00000001 COMCTL32!CListView::WndProc+0x2d41f
2b 00d7d7e8 76c0be6b 00020244 00000201 00000001 COMCTL32!CListView::s_WndProc+0x57
2c 00d7d814 76c0833a 71b1e870 00020244 00000201 USER32!_InternalCallWinProc+0x2b
2d 00d7d8fc 76be7afd 71b1e870 00000000 00000201 USER32!UserCallWinProcCheckWow+0x3aa
2e 00d7d938 71b3aadd 71b1e870 00020244 00000201 USER32!CallWindowProcW+0x8d
2f 00d7d9c0 71b3ab7b 00000201 00000001 00b60119 COMCTL32!CallNextSubclassProc+0x11d
30 00d7da40 71b3a876 00000201 00000001 00b60119 COMCTL32!CallNextSubclassProc+0x1bb
31 00d7da60 75360d11 00020244 00000201 00000001 COMCTL32!DefSubclassProc+0x56
32 00d7dcf0 71b3aa82 00020244 00000201 00000001 SHELL32!CListViewHost::s_ListViewSubclassWndProc+0x511
33 00d7dd7c 71b3a935 00000201 00000001 00b60119 COMCTL32!CallNextSubclassProc+0xc2
34 00d7ddd8 76c0be6b 00020244 00000201 00000001 COMCTL32!MasterSubclassProc+0xa5
35 00d7de04 76c0833a 71b3a890 00020244 00000201 USER32!_InternalCallWinProc+0x2b
36 00d7deec 76c07bee 71b3a890 00000000 00000201 USER32!UserCallWinProcCheckWow+0x3aa
37 00d7df68 76bea2c3 003b04e4 00000000 0014013a USER32!DispatchMessageWorker+0x20e
38 00d7df98 76be903f 0014013a 00d7dfb4 003b04e4 USER32!IsDialogMessageW+0x103
39 00d7dfe0 76be4b0a 00000000 00000001 0b0aafc8 USER32!DialogBox2+0x13e
3a 00d7e014 76be4a22 003b04e4 76a85d60 115429c0 USER32!InternalDialogBox+0xdf
3b 00d7e02c 76be49db 76a30000 115a4d10 003b04e4 USER32!DialogBoxIndirectParamAorW+0x32
3c 00d7e04c 76a732f6 76a30000 115a4d10 003b04e4 USER32!DialogBoxIndirectParamW+0x1b
3d 00d7e188 76a7d5ed 115429c4 003b04e4 00000000 COMDLG32!CFileOpenSave::Show+0x346
3e 00d7e1bc 76a78dc7 003b04e4 00d7e204 00000000 COMDLG32!_InvokeNewFileOpenSave+0xdb
3f 00d7e1ec 76a6a8e1 00d7e204 76a4a2e0 11506fa8 COMDLG32!_CreateNewFileOpenSaveInProc+0xd7
40 00d7e220 76a4b215 00d7f360 11506fa8 00000000 COMDLG32!NewGetFileName+0x122
41 00d7e248 76a4afa3 e4eaea9d 1149ccc8 115108f0 COMDLG32!GetFileName+0xd4
42 00d7f32c 76a4b9c2 00d7f4c0 013d4618 00d7f360 COMDLG32!GenericGetFileNameA+0x541
43 00d7f334 013d4618 00d7f360 76c0d330 00000000 COMDLG32!GetOpenFileNameA+0x22
44 00d7f4c0 01442ac7 00d7f4f4 00d7f4f0 00000001 xnview+0x114618
45 00d7f604 013cc433 003b04e4 0001000b 00000001 xnview+0x182ac7
46 00d7f630 01446826 0000001a 00000001 00000000 xnview+0x10c433
47 00d7f64c 013cc343 003b04e4 00000111 0001000b xnview+0x186826
48 00d7f674 014468e9 00000111 0001000b 00000000 xnview+0x10c343
49 00d7f688 76c0be6b 003b04e4 00000111 0001000b xnview+0x1868e9
4a 00d7f6b4 76c0833a 014468d0 003b04e4 00000111 USER32!_InternalCallWinProc+0x2b
4b 00d7f79c 76c07eda 014468d0 00000000 00000111 USER32!UserCallWinProcCheckWow+0x3aa
4c 00d7f800 76c0a629 0730d320 00000000 00000111 USER32!DispatchClientMessage+0xea
4d 00d7f840 76f9b96d 00d7f85c 00000020 00d7fa88 USER32!__fnDWORD+0x49
4e 00d7f878 740d2bec 76bf89ff 003b04e4 00a604a7 ntdll!KiUserCallbackDispatcher+0x4d
4f 00d7f87c 76bf89ff 003b04e4 00a604a7 00d7f8dc win32u!NtUserTranslateAccelerator+0xc
50 00d7f89c 0144a293 003b04e4 00a604a7 00d7f8dc USER32!TranslateAcceleratorA+0x4f
51 00d7fa4c 01644d80 012c0000 00000000 00ecfff8 xnview+0x18a293
52 00d7fa98 76d78484 00bb7000 76d78460 aa556442 xnview+0x384d80
53 00d7faac 76f92ec0 00bb7000 0bf17ada 00000000 KERNEL32!BaseThreadInitThunk+0x24
54 00d7faf4 76f92e90 ffffffff 76fadec1 00000000 ntdll!__RtlUserThreadStart+0x2f
55 00d7fb04 00000000 01644c79 00bb7000 00000000 ntdll!_RtlUserThreadStart+0x1b
```
