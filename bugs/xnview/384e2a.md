# XnView Standard v2.48 BMP Heap OOB, xnview+0x384e2a

Last version at the moment of publication is 2.48

![](https://i.imgur.com/IHBmtQS.png)

![](https://i.imgur.com/bJ95x8t.png)


## Steps to reproduce

1. Use XnView Standard v2.48
2. Enable pageheap (without verifier reproducing process can be unstable)
```
C:\Program Files (x86)\Windows Kits\10\Debuggers\x86>gflags /p /enable xnview.exe /full
Warning: pageheap.exe is running inside WOW64.
This scenario can be used to test x86 binaries (running inside WOW64)
but not native (IA64) binaries.

path: SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options
    xnview.exe: page heap enabled
```
3. Run windbg
4. Open XnView in windbg
5. Open testcase in XnView

## The bug

BMP file processing Heap OOB, eip xnview+0x384e2a

```
(324.95c): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=0a9b2c10 ebx=00000000 ecx=00000010 edx=00000040 esi=0a9b2c00 edi=0b56e000
eip=01134e2a esp=015ad778 ebp=015ad790 iopl=0         nv up ei pl nz na pe cy
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010207
xnview+0x384e2a:
01134e2a f3a4            rep movs byte ptr es:[edi],byte ptr [esi]
0:000> kb
 # ChildEBP RetAddr  Args to Child              
WARNING: Stack unwind information not available. Following frames may be wrong.
00 015ad790 00fe4c8c 0a9b2bd0 0b56dfd0 00000010 xnview+0x384e2a
01 015ad7b8 010b3825 0a9b2bd0 00000000 00000010 xnview+0x234c8c
02 015ad80c 010b30ce 17d24f60 17c76ca8 00000000 xnview+0x303825
03 015ada18 010b2c62 17d24f60 17c76ca8 00000000 xnview+0x3030ce
04 015ada30 00fe4505 17d24f60 17c76ca8 17c76ca8 xnview+0x302c62
05 015ada4c 00fe4424 17d24f60 17c76ca8 00000000 xnview+0x234505
06 015adb74 00fe8735 17d24f60 17c76ca8 00000004 xnview+0x234424
07 015adba8 00fe84cc 015ae0e0 17d30340 015adbf8 xnview+0x238735
08 015adbd0 00ec3174 015ae0e0 17d30340 015adbf8 xnview+0x2384cc
09 015ae1f4 00f2f6f8 015ae478 00000000 17d30340 xnview+0x113174
0a 015ae58c 00f3066e 015ae740 17d30130 00000001 xnview+0x17f6f8
0b 015af17c 00f30ca5 015af3f4 00000000 00000000 xnview+0x18066e
0c 015af1bc 00ebc343 000d042e 00000401 00000000 xnview+0x180ca5
0d 015af1e4 00f368e9 00000401 00000000 015af3dc xnview+0x10c343
0e 015af1f8 76c0be6b 000d042e 00000401 00000000 xnview+0x1868e9
0f 015af224 76c0833a 00f368d0 000d042e 00000401 USER32!_InternalCallWinProc+0x2b
10 015af30c 76bebeca 00f368d0 00000000 00000401 USER32!UserCallWinProcCheckWow+0x3aa
11 015af37c 76bebab1 07665ce0 00000000 015af3dc USER32!SendMessageWorker+0x20a
12 015af3b4 00f32bb2 000d042e 00000401 00000000 USER32!SendMessageA+0x131
13 015af4fc 00ebc433 000d042e 0001000b 00000001 xnview+0x182bb2
14 015af528 00f36826 0000001a 00000001 00000000 xnview+0x10c433
15 015af544 00ebc343 000d042e 00000111 0001000b xnview+0x186826
16 015af56c 00f368e9 00000111 0001000b 00000000 xnview+0x10c343
17 015af580 76c0be6b 000d042e 00000111 0001000b xnview+0x1868e9
18 015af5ac 76c0833a 00f368d0 000d042e 00000111 USER32!_InternalCallWinProc+0x2b
19 015af694 76c07eda 00f368d0 00000000 00000111 USER32!UserCallWinProcCheckWow+0x3aa
1a 015af6f8 76c0a629 07665ce0 00000000 00000111 USER32!DispatchClientMessage+0xea
1b 015af738 76f9b96d 015af754 00000020 015af97c USER32!__fnDWORD+0x49
1c 015af770 740d2bec 76bf89ff 000d042e 00370843 ntdll!KiUserCallbackDispatcher+0x4d
1d 015af774 76bf89ff 000d042e 00370843 015af7d4 win32u!NtUserTranslateAccelerator+0xc
1e 015af794 00f3a293 000d042e 00370843 015af7d4 USER32!TranslateAcceleratorA+0x4f
1f 015af940 01134d80 00db0000 00000000 0412fff8 xnview+0x18a293
20 015af98c 76d78484 01738000 76d78460 d6896e03 xnview+0x384d80
21 015af9a0 76f92ec0 01738000 8adc1d0c 00000000 KERNEL32!BaseThreadInitThunk+0x24
22 015af9e8 76f92e90 ffffffff 76fadea1 00000000 ntdll!__RtlUserThreadStart+0x2f
23 015af9f8 00000000 01134c79 01738000 00000000 ntdll!_RtlUserThreadStart+0x1b
0:000> db edi
0b56e000  ?? ?? ?? ?? ?? ?? ?? ??-?? ?? ?? ?? ?? ?? ?? ??  ????????????????
0b56e010  ?? ?? ?? ?? ?? ?? ?? ??-?? ?? ?? ?? ?? ?? ?? ??  ????????????????
0b56e020  ?? ?? ?? ?? ?? ?? ?? ??-?? ?? ?? ?? ?? ?? ?? ??  ????????????????
0b56e030  ?? ?? ?? ?? ?? ?? ?? ??-?? ?? ?? ?? ?? ?? ?? ??  ????????????????
0b56e040  ?? ?? ?? ?? ?? ?? ?? ??-?? ?? ?? ?? ?? ?? ?? ??  ????????????????
0b56e050  ?? ?? ?? ?? ?? ?? ?? ??-?? ?? ?? ?? ?? ?? ?? ??  ????????????????
0b56e060  ?? ?? ?? ?? ?? ?? ?? ??-?? ?? ?? ?? ?? ?? ?? ??  ????????????????
0b56e070  ?? ?? ?? ?? ?? ?? ?? ??-?? ?? ?? ?? ?? ?? ?? ??  ????????????????
0:000> db edi-10
0b56dff0  c0 c0 c0 c0 c0 c0 c0 c0-c0 c0 c0 c0 c0 c0 c0 c0  ................
0b56e000  ?? ?? ?? ?? ?? ?? ?? ??-?? ?? ?? ?? ?? ?? ?? ??  ????????????????
0b56e010  ?? ?? ?? ?? ?? ?? ?? ??-?? ?? ?? ?? ?? ?? ?? ??  ????????????????
0b56e020  ?? ?? ?? ?? ?? ?? ?? ??-?? ?? ?? ?? ?? ?? ?? ??  ????????????????
0b56e030  ?? ?? ?? ?? ?? ?? ?? ??-?? ?? ?? ?? ?? ?? ?? ??  ????????????????
0b56e040  ?? ?? ?? ?? ?? ?? ?? ??-?? ?? ?? ?? ?? ?? ?? ??  ????????????????
0b56e050  ?? ?? ?? ?? ?? ?? ?? ??-?? ?? ?? ?? ?? ?? ?? ??  ????????????????
0b56e060  ?? ?? ?? ?? ?? ?? ?? ??-?? ?? ?? ?? ?? ?? ?? ??  ????????????????
```
